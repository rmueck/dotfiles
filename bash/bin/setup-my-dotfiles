#!/bin/bash

set -e

MASTER_REPO="/etc/dotfiles"
DEFAULT_PACKAGES=("bash" "vim" "fzf" "tmux" "rclone" "python")
PACKAGES=("$@")

if [ ${#PACKAGES[@]} -eq 0 ]; then
    PACKAGES=("${DEFAULT_PACKAGES[@]}")
fi

USER_DOTFILES="$HOME/.dotfiles"

echo "Setting up dotfiles for $USER..."
echo "Packages: ${PACKAGES[*]}"

# Check if master repo exists and is readable
if [ ! -r "$MASTER_REPO" ]; then
    echo "Error: Cannot read $MASTER_REPO"
    echo "Please ensure /etc/dotfiles exists and is readable."
    exit 1
fi

# Remove existing if present
if [ -d "$USER_DOTFILES" ]; then
    echo "Warning: $USER_DOTFILES already exists"
    read -p "Remove and recreate? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$USER_DOTFILES"
    else
        echo "Aborting."
        exit 1
    fi
fi

# Copy dotfiles
echo "Copying dotfiles..."
mkdir -p "$USER_DOTFILES"
cp -r "$MASTER_REPO"/* "$USER_DOTFILES/" 2>/dev/null || true
cp -r "$MASTER_REPO"/.??* "$USER_DOTFILES/" 2>/dev/null || true

# Remove master's .git if it was copied
rm -rf "$USER_DOTFILES/.git"

# Remove nested git repos
find "$USER_DOTFILES" -mindepth 2 -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true

# Initialize git
cd "$USER_DOTFILES"
git config --global init.defaultBranch main 2>/dev/null || true
git init
git add .
git commit -m "Initial dotfiles setup"

echo "âœ“ Repository initialized"

# Deploy packages
echo "Deploying packages..."
for package in "${PACKAGES[@]}"; do
    if [ ! -d "$package" ]; then
        echo "Warning: Package '$package' not found, skipping..."
        continue
    fi

    echo "  - Deploying $package"
    stow -t "$HOME" "$package" 2>&1 | grep -v "BUG in find_stowed_path" || true
done

echo ""
echo "âœ“ Dotfiles initialized successfully for $USERNAME!"
echo ""
echo "User $USERNAME can now:"
echo "  â€¢ Make changes in ~/.dotfiles/"
echo "  â€¢ Commit changes: cd ~/.dotfiles && git add . && git commit -m 'message'"
echo "  â€¢ View history: cd ~/.dotfiles && git log"
echo "  â€¢ Restow after changes: cd ~/.dotfiles && stow -R bash"
echo "  â€¢ðŸ’¡ Do not forget to decrypt the rclone config in ~./config/rclone!"
echo "  â€¢ðŸ’¡ Do not forget to make your venv (one time) with mkvenv"
echo "  â€¢ðŸ’¡ Do not forget to cleanup your vim Plug (one time) with :PlugClean/PlugInstall"
echo ""
echo "This is now $USERNAME's independent dotfiles repository."

